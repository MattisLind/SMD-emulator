SMD-emulator
============

SMD emulator using SD card

This project aim to create an SMD disk drive emulator that uses a SD card as storage. The soluton would be based on a STM32 family chip
and some logic and line drivers and receivers.

SMD disc signals
----------------

The SMD interface uses two cables, A and B cable. The A cable is the control cable that attaches to all discs in a daisy-chain.
The B cable is the data cable and attaches to each of the disc drives.

#### A cable pinout

| Low pin | High pin | Signal name       | Used by emulation |
|---------|----------|-------------------|-------------------|
|   1     |   31     | Tag 1             |         Y         |
|   2     |   32     | Tag 2             |         Y         |
|   3     |   33     | Tag 3             |         Y         |
|   4     |   34     | Bus 0             |         Y         |
|   5     |   35     | Bus 1             |         Y         |
|   6     |   36     | Bus 2             |         Y         |
|   7     |   37     | Bus 3             |         Y         |
|   8     |   38     | Bus 4             |         Y         |
|   9     |   39     | Bus 5             |         Y         |
|  10     |   40     | Bus 6             |         Y         |
|  11     |   41     | Bus 7             |         Y         |
|  12     |   42     | Bus 8             |         Y         |
|  13     |   43     | Bus 9             |         Y         |
|  14     |   44     | Open Cable Detect |         Y         |
|  15     |   45     | Fault             |         Y         |
|  16     |   46     | Seek Error        |         Y         |
|  17     |   47     | On Cylinder       |         Y         |
|  18     |   48     | Index             |         Y         |
|  19     |   49     | Unit Ready        |         Y         |
|  20     |   50     | (AM Found)  (1)   |         N         |
|  21     |   51     | (Busy)  (2)       |         N         |
|  22     |   52     | Unit Select Tag   |         Y         |
|  23     |   53     | Unit Select bit 0 |         Y         |
|  24     |   54     | Unit Select bit 1 |         Y         |
|  25     |   55     | Sector            |         Y         |
|  26     |   56     | Unit Select bit 2 |         Y         |
|  27     |   57     | Unit Select bit 3 |         Y         |
|  28     |   58     | Write Protected   |         Y         |
|  29     |          | Pick              |         N         |
|         |   58     | Hold              |         N         |
|  30     |   60     | (Tag 4) (3)       |         N         |

1. Used only with soft sectored disc drives.
2. Used only with dual channel disc drives.
3. The SMD-E interface is supporting Tag 4 and Tag 5.

### B cable pinout

| Low pin | High pin | Signal name       | Used by emulation |
|---------|----------|-------------------|-------------------|
|   2     |   14     | Servo Clock       |         Y         |
|   3     |   16     | Read Data         |         Y         |
|   5     |   17     | Read Clock        |         Y         |
|   6     |   19     | Write Clock       |         Y         |
|   8     |   20     | Write Data        |         Y         |
|  22     |    9     | Unit Selected     |         Y         |
|  12     |   24     | Index             |         Y         |
|  13     |   26     | Sector            |         Y         |
|   1     |          | GND               |         Y         |
|   4     |          | GND               |         Y         |
|   7     |          | GND               |         Y         |
|  11     |          | GND               |         Y         |
|  15     |          | GND               |         Y         |
|  18     |          | GND               |         Y         |
|  21     |          | GND               |         Y         |
|  25     |          | GND               |         Y         |

SMD interface
-------------

![Index Sector timing](http://i.imgur.com/uuZ3x6B.png "Index Sector Timing")

The Index and Sector sigals is generated by the emulation and provided both in the A and B cables. These signals is generated by chained timers inside the STM32 chip. The emulation also generate the 10 MHz Servo Clock signal and Read Clock signal using a timer inside the STM32.



The SMD interafce has foru tag signals, Unit Select tag, Tag 1, Tag 2 and Tag3. The tag signals act as strobe signals. Unit Select Tag is used to strobe the Unit Select Bit 0 - Unit Select Bit 3 into the drive. Tag 1 - Tag 3 is used to strobe in the data on the Bus 0 - Bus 9 signals. Tag 1 strobes the cylinder address, Tag 2 strobes the head address and Tag 3 strobes Write gate, Read gate, Servo Offset Plus, Servo Offset Minus, Fault Clear, Address Mark Enable, RTZ, Data Strobe Early, Data Strobe Late and Release.

This emulation would only use the Unit Select tag for unit selection,  Tag 1 for Track, Tag 2 for Head and Tag 3 for Write Gate, Read Gate, Fault Clear, RTZ.

The Index and Sector sigals is generated by the emulation and provided both in the A and B cables. These signals is generated by chained timers inside the STM32 chip. The emulation also generate the 10 MHz Servo Clock signal and Read Clock signal using a timer inside the STM32.

The emulation generate Write Protected, Unit Ready, On Cylinder, Seek Error and Fault signals on the A cable and Unit Selected on the B cable. It handles the Open Cable Detect signal on the A cable.

Not supported signals are Busy, AM Found, Pick, Hold, and Tag 4.

![Write clock and data timing](http://i.imgur.com/2zWGFky.png "Write clock and data timing")

Write Data is handled by one of the SPI peripherlas in the STM32. The clock signals used is the Write Clock signal from the controller which has been gated by the latched Write Gate signal. Thus data is recived only when the Write gate is enabled.

![Read clock and data timing](http://i.imgur.com/oeRLdh0.png "Read clock and data timing")

Read Data is handled similarily by a SPI peripheral in the STM32. The clock signal is gated by the latched Read Gate signal as received from the controller and isthe 10 MHz Read Clock and Servo clock generated by a timer peripheral in the STM32 chip. 

![Format track timimg](http://i.imgur.com/1zJVYCS.png "Format track timing")

![Write sector timimg](http://i.imgur.com/4gdz9nc.png "Write sector timing")

![Read sector timimg](http://i.imgur.com/QNRXla0.png "Read sector timing")

The logic inside the STM32 program checks if a read SPI character is available, it then reads it and writes it to the RAM at an offset taken from the current byte position which is caclulated by the Index and Sector timer peripherals. It then chcks if there is the send buffer is empty. In that case it reads a memory buffer at same position and writes it to the send buffer. Then repeat.

The track is stored in raw format in RAm and then written back to flash in disk image format. The format of the track is:
![Sector Format](http://i.imgur.com/7pC46Qv.png "Sector format")

| Field Name                        | Size (Bytes) | Value |
|-----------------------------------|--------------|-------|
| Gap 1                             | 16           |       |
| VFO Sync                          | 11           | 00    |
| Sync Pattern Byte                 | 1            | 0E    |
| Flag Status and Logical Unit Byte | 1            |       |
| Upper Cylinder Address            | 1            |       |
| Lower Cylinder Address            | 1            |       |
| Head Address                      | 1            |       |
| Sector Address                    | 1            |       |
| CRC                               | 2            |       |
| Write Splice                      | 1            |       |
| VFO Sync                          | 13           | 00    |
| Sync Pattern                      | 1            | 09    |
| Data Area                         | n            |       |
| CRC                               | 2            |       |
| EOR Pad                           | 1            |       |
| Gap 3                             | 11           |       |

Interrupt based logic handles the Tag 1, Tag 2 and Unit Select Tag signals together with the Unit Select bits and Bus bits to selct a particular unit or to perform a seek. Bus signals is latched with Tag 3 to handle Write Gate, Read Gate, Fault Clear and RTZ.
